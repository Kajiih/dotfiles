# KJ's dotfiles

Cross platform tools managed by cross platforms package managers, at least in theory..!

⚠️ **This repo is tested for SOME config only, not a full machine setup from scratch, and only on MacOS (specifically my Mac M2 laptop), so it will have to be fine tuned for other systems and architectures with time. Only some files contain templates that separate Mac specific config to platform agnostic config.**

## Usage

### Main principles

Dotfiles are stored at 3 locations:

- **real dotfiles**: the real config locations that apps are reading; e.g., `~/.config/git`. They are generated by chezmoi using the source/local repo.
- **local repo**: local repository containing the **source** of your dotfiles as `chezmoi` sees them. It is like a regular git repository located at `~/.local/share/chezmoi`.
- **remote repo**: a regular remote repository like on GitHub; e.g., [the current repository you are browsing](https://github.com/Kajiih/dotfiles)

Changes have to be propagated from **source/local repo** to **real dotfiles** with `update`, or changes to **real dotfiles** have to be merged into the **source repo** with `merge`.

Operations in the chezmoi repository (which is a git repository) are like any regular git repo: `commit`, `push`, `pull`, etc.

### Setting up new machine

- [Optional] Set your hostname if your dotfiles depend on it.
  - [macOS](https://apple.stackexchange.com/a/461489)
- Install [`chezmoi`](https://www.chezmoi.io/install/) and probably [`nushell`](https://www.nushell.sh/book/installation.html)
  - Probably set `nushell` as login shell
- Install package managers
  - brew, uv tools and cargo binstall
- Apply dotfiles: `chezmoi init --apply kajiih`
  - More info in [chezmoi's doc](https://www.chezmoi.io/user-guide/daily-operations/#install-chezmoi-and-your-dotfiles-on-a-new-machine-with-a-single-command)
- Setup secrets (e.g. with keychain on mac, etc)
- Setup [things that have yet to be setup manually](/docs/thing-to-setup-manually.md)
- and more

### Using `Chezmoi`

- `update` to sync real dotfiles with remote repo
- `apply` to sync real dotfiles with the local repo
  - also `diff` to see what changes would be made
- `edit $FILE` to edit the file in the local repo (but not the real file until apply)
  - Same as directly editing the file in the source repo
  - More [info](https://www.chezmoi.io/user-guide/frequently-asked-questions/usage/#how-do-i-edit-my-dotfiles-with-chezmoi)
- `merge $FILE` to merge changes to real dotfile into the source repo
- `git commit` and `git push` to sync with remote
  - Like a regular git repo
  - More [info](https://www.chezmoi.io/user-guide/frequently-asked-questions/usage/#once-ive-made-a-change-to-the-source-directory-how-do-i-commit-it)
- `status`, `managed`, `unmanaged`: useful to get info

## Features

- Managed with [Chezmoi](https://www.chezmoi.io/)
- [Nushell](https://www.nushell.sh/) as login shell
- [Ghostty](https://ghostty.org/) as terminal emulator
- [Firefox](https://www.mozilla.org/en-US/firefox/new/) as main browser

- Secret loading with `bitwarden secrets`
  - MacOS: Token access in `keychain`. To add the [access token of your machine account](https://vault.bitwarden.eu/#/sm/6e2de25d-081c-40c1-ab1e-b1f700e89888/projects/f2a257f6-7179-4f88-9c77-b2ee01342082/machine-accounts):

    ```nu
    security add-generic-password -a $env.USER -s bws_token -w <access_token>
    ```

- Cross platform package managers (MacOs, Linux, WSL) by order of precedence:
  - [Homebrew](/dot_config/homebrew/Brewfile)
  - [Cargo](/.chezmoiscripts/run_onchange_install-cargo-bins.nu)
  - [uv tool](https://docs.astral.sh/uv/concepts/tools/)

- [Karabiner Elements](https://karabiner-elements.pqrs.org/) + [karabiner.ts-greg-mods](https://github.com/gregorias/karabiner.ts-greg-mods) for keyboard mapping and home row mods

- `XDG_CONFIG_HOME` and `XDG_DATA_HOME` set on all platforms

## Roadmap

- [WIP] Cross platform
  - [ ] Windows
  - [x] Mac
    - [ ] Move _Bitwarden_ to Mac Appstore because it can't integrate with browser otherwise.
  - [ ] Linux
- Settings (currently only on macOS)
  - [x] Key repeat rate
  - [x] Delay after repeat
  - [x] Press and hold key (for accent)
- Replace Karabiner Element by [Kanata](https://github.com/jtroo/kanata) when the installation will be better on macOS
- [ ] add rust/binstall
- [ ] Check if it's possible to automatically install nushell and then use it in scripts
- [ ] add env variables for atuin setup
- [x] Explain how to setup config path for nu, because it's not obvious (or maybe make sure that XDG_CONFIG_HOME is set before).
- [ ] Setup scripts for `carapace` and `atuin`
  - [ ] Also in [nushell config](/home/dot_config/nushell/config.nu) make lines about sourcing those files dependent on the whether or not the binaries are available (it will probably crash if they are not installed)

### May be added

- [Gemini CLI](https://github.com/google-gemini/gemini-cli)

## XDG_ paths

### MacOS

Create a file `~/Library/LaunchAgents/<whatever>.plis`, with the following content (⚠️ don't use comments, it doesn't work):

```xml
<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>my.startup.shell_agnostic.environment</string>
    <key>ProgramArguments</key>
    <array>
        <string>/bin/sh</string>
        <string>-c</string>
        <string>
            launchctl setenv XDG_CONFIG_HOME /Users/<user_name>/.config &&
            launchctl setenv XDG_DATA_HOME /Users/<user_name>/.local/share
        </string>
    </array>
    <key>RunAtLoad</key>
    <true/>
    <key>ServiceIPC</key>
    <false/>
</dict>
</plist>
```

More info in this [GitHub issue](https://github.com/nushell/nushell/discussions/14663#discussioncomment-11876260).

## Resources

- [Reference repo](https://github.com/twpayne/dotfiles/tree/master)
