# KJ's dotfiles

Cross platform tools managed by cross platforms package managers, at least in theory..!

⚠️ **This config setup is still in early development, don't expect a setup from scratch to be without any sharp edges or errors to fix along the way.**

## Usage

### Main principles

Dotfiles are mirrored in 3 locations:

- **real dotfiles**: the real config locations that apps are reading;
   e.g., `~/.config/git`. They are generated by chezmoi using the local/source repo.
- **local chezmoi repository**: the **source/template** of your dotfiles as chezmoi sees them.
  It is like a regular git repository located at `~/.local/share/chezmoi`.
- **remote repository**: a regular remote repository on GitHub;
  e.g., [the current repository you are browsing](https://github.com/Kajiih/dotfiles)

When manually changing an app's config, you should to it in the **source**, aka the **local chezmoi repository**, and propagate changes with `chezmoi apply`.
If changes are made to the **real dotfiles**, you can merge them into the **source** with `chezmoi merge`, or you can manually re-add the config to the managed dotfiles with `chezmoi add`.

Operations in the **local chezmoi repository** (which is a git repository) are like any regular git repo: `commit`, `push`, `pull`, etc.

### Setting up new machine

- [Optional] Set your hostname if your dotfiles depend on it.
  - [macOS](https://apple.stackexchange.com/a/461489)
- Install [`chezmoi`](https://www.chezmoi.io/install/) and [`nushell`](https://www.nushell.sh/book/installation.html)
  - [Optional] Set `nushell` as login shell
- Install package managers
  - [brew](https://brew.sh/), uv tools
- Apply dotfiles: `chezmoi init --apply kajiih`
  - More info in [chezmoi's doc](https://www.chezmoi.io/user-guide/daily-operations/#install-chezmoi-and-your-dotfiles-on-a-new-machine-with-a-single-command)
- Setup secrets (e.g. with keychain on mac, etc)
- Setup [things that have yet to be setup manually](/docs/thing-to-setup-manually.md)
- and more

### Using `Chezmoi`

- `update` to sync real dotfiles with remote repo
- `apply` to sync real dotfiles with the local repo
  - also `diff` to see what changes would be made
- `edit $FILE` to edit the file in the local repo (but not the real file until apply)
  - Same as directly editing the file in the source repo
  - More [info](https://www.chezmoi.io/user-guide/frequently-asked-questions/usage/#how-do-i-edit-my-dotfiles-with-chezmoi)
- `merge $FILE` to merge changes to real dotfile into the source repo
- `git commit` and `git push` to sync with remote
  - Like a regular git repo
  - More [info](https://www.chezmoi.io/user-guide/frequently-asked-questions/usage/#once-ive-made-a-change-to-the-source-directory-how-do-i-commit-it)
- `status`, `managed`, `unmanaged`: useful to get info

### Generating configs for specific devices (for example if they can't use chezmoi)

Then manually execute necessary scripts and copy the config files you want

## Features

- Managed with [Chezmoi](https://www.chezmoi.io/)
- [Nushell](https://www.nushell.sh/) as login shell
- [Ghostty](https://ghostty.org/) as terminal emulator
- [Firefox](https://www.mozilla.org/en-US/firefox/new/) as main browser
  - Will become Zen

- Secret loading with `bitwarden secrets`
  - MacOS: Token access in `keychain`. To add the [access token of your machine account](https://vault.bitwarden.eu/#/sm/6e2de25d-081c-40c1-ab1e-b1f700e89888/projects/f2a257f6-7179-4f88-9c77-b2ee01342082/machine-accounts):

    ```nu
    security add-generic-password -a $env.USER -s bws_token -w <access_token>
    ```

- Cross platform package managers (MacOs, Linux, WSL) by order of precedence:
  - [Homebrew](/dot_config/homebrew/Brewfile)
  - [Cargo](/.chezmoiscripts/run_onchange_install-cargo-bins.nu)
  - [uv tool](https://docs.astral.sh/uv/concepts/tools/)

- [Karabiner Elements](https://karabiner-elements.pqrs.org/) + [karabiner.ts-greg-mods](https://github.com/gregorias/karabiner.ts-greg-mods) for keyboard mapping and home row mods

- `XDG_CONFIG_HOME` and `XDG_DATA_HOME` set on all platforms

## Roadmap

- [WIP] Cross platform
  - [ ] Windows
  - [x] Mac
    - [ ] Move _Bitwarden_ to Mac Appstore because it can't integrate with browser otherwise.
  - [ ] Linux
- Replace Karabiner Element by [Kanata](https://github.com/jtroo/kanata) when the installation will be better on macOS
- Remove Firefox features and add setup for Zen browser instead

### Empirical rules for scalable dotfiles

Each machine should receive its own config only; all differences should be handled by chezmoi with templates.
Chezmoi should be as transparent as possible and not appear in other app's config (e.g., no link to helpers or code from your local chezmoi's repository; this should only be used during generation.).

Use `nu` for scripts ran by chezmoi.
Avoid relying on chezmoi templates in scripts; export chezmoi variables such as device name or os in the [dot_chezmoi_variables](home/dot_config/dot_chezmoi_variables.nu.tmpl) module, and import necessary variable in the script.

When you add a new app's configuration, create an installation script and if necessary a setup script for it. Use [helper modules](helpers) to install apps with package managers and printing/logging information.
Leverage locality of behavior and group installation/setup or any other scripts inside the app's config folder.
Also, use `.chezmoiignore` files to fine tune which machine uses which app.

### May be added

- Config for [Gemini CLI](https://github.com/google-gemini/gemini-cli)

## XDG_[...] paths

### MacOS

Create a file `~/Library/LaunchAgents/<whatever>.plis`, with the following content (⚠️ don't use comments; it will break):

```xml
<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>my.startup.shell_agnostic.environment</string>
    <key>ProgramArguments</key>
    <array>
        <string>/bin/sh</string>
        <string>-c</string>
        <string>
            launchctl setenv XDG_CONFIG_HOME /Users/<user_name>/.config &&
            launchctl setenv XDG_DATA_HOME /Users/<user_name>/.local/share
        </string>
    </array>
    <key>RunAtLoad</key>
    <true/>
    <key>ServiceIPC</key>
    <false/>
</dict>
</plist>
```

More info in this [GitHub issue](https://github.com/nushell/nushell/discussions/14663#discussioncomment-11876260).

## Resources

- [Reference repo](https://github.com/twpayne/dotfiles/tree/master)
